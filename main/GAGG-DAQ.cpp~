#include <iostream>

#include "Config.h"
#include "Log.h"
#include "Bridge.h"
#include "Digitizer.h"

int main(int argc, char** argv)
{
    if (argc != 2)
    {
        std::cout << "You need to supply the toml config-file (and only that) to the program." << std::endl;
        std::cout << "Usage: ./GAGG-DAQ /path/to/config-file.toml" << std::endl;
        return 1;
    }
    

    // Ottieni istanza singleton Config e leggi file
    Config& theConfig = Config::GetInstance();
    theConfig.Read(argv[1]);

    Log::OpenLog(Log::LogLevel::debug);
    Log::OutSummary("* * * * * * * * * * * * * * *");
    Log::OutSummary("*                           *");
    Log::OutSummary("*  Welcome to the GAGG DAQ  *");
    Log::OutSummary("*                           *");
    Log::OutSummary("* * * * * * * * * * * * * * *");
    Log::OutSummary();

    // Inizializza il bridge VME (V4718)
    Bridge bridge(theConfig);
    bridge.Open();

    Digitizer digitizer;
    digitizer.SelectBoard();       // 1. Connessione al V1742
    digitizer.Configure();         // 2. Configurazione base
    digitizer.InitAcquisition();
    digitizer.SetTriggerThreshold(0.1);


    ///////////////////////////////////////  baseline////////////////////////////
    CAEN_DGTZ_SetChannelSelfTrigger(digitizer.GetHandle(), CAEN_DGTZ_TRGMODE_ACQ_ONLY, 0xFF);  // Tutti i canali
    CAEN_DGTZ_SetExtTriggerInputMode(digitizer.GetHandle(), CAEN_DGTZ_TRGMODE_DISABLED);
     uint32_t trigStatus = 0;
    CAEN_DGTZ_ReadRegister(digitizer.GetHandle(), 0x812C, &trigStatus);
    //Log::OutDebug("Trigger Status Register (0x812C): " + std::to_string(trigStatus));
    digitizer.SetTriggerThreshold(0.1);  
    /////////////////////////////////////////////////////////////////////////////
    
    ////////////////// Main loop ...Acquire events with external trigger////////
    CAEN_DGTZ_SetChannelSelfTrigger(digitizer.GetHandle(), CAEN_DGTZ_TRGMODE_DISABLED, 0xFF);
    CAEN_DGTZ_SetExtTriggerInputMode(digitizer.GetHandle(), CAEN_DGTZ_TRGMODE_ACQ_ONLY);
    //    Log::OutDebug("Trigger configuration: ExternalTrigger = ON, SelfTrigger = OFF (mode = NIM)");

    
    //uint32_t trigStatus = 0;
    CAEN_DGTZ_ReadRegister(digitizer.GetHandle(), 0x812C, &trigStatus);
    //Log::OutDebug("Trigger Status Register (0x812C): " + std::to_string(trigStatus));
    

    digitizer.PrepareOutput();     // crea file HDF5, directory, gruppo "/events"
    digitizer.AcquireEvents();     // scrive gli eventi nel file HDF5
    digitizer.CloseOutputFile();   // chiude il gruppo e il file HDF5
    digitizer.Close();             // 6. Cleanup
    digitizer.Reset();

    bridge.Close();  // opzionale
    return 0;
}

